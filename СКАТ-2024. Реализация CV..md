
В данном отчете периодически будут упоминаться файлы и части кода из репозитория https://github.com/Rockntt/SKAT_2024 . Инструкция по запуску программы и ответы на возможные вопросы уже доступны на GitHub.
Для лучшего восприятия общей картины рекомендуется туда посматривать при прочтении :)

### Немного чисел
##### Системные требования для работы программы:

ОЗУ: мин. 75 МБ
Место на диске: 12 КБ
Установлен Python 3.11 вместе с необходимыми пакетами ($ pip install -r requirements.txt)

##### Оценка скорости распознавания одного кадра с  буквой на 10 запусках

| № Операции | Затраченное время |
| ---------- | ----------------- |
| 1          | 0,07              |
| 2          | 0,063             |
| 3          | 0,063             |
| 4          | 0,073             |
| 5          | 0,066             |
| 6          | 0,064             |
| 7          | 0,067             |
| 8          | 0,066             |
| 9          | 0,072             |
| 10         | 0,068             |
Среднее время - 0,067 с.
Данные измерения были получены с помощью системы логирования, которая уведомляет в консоли, а так же записывает в файл, связанный с актуальной датой, все важные события - включение камеры, успешное распознавание буквы, выключение камеры и предупреждения с ошибками, если они появляются в ходе работы. Помимо этого все сообщения разделяются по категориям с помощью традиционных цветов: категория INFO - белый, SUCCESS - зеленый, WARNING - жёлтый, ERROR - красный
### Вступление

В ходе поиска пути реализации компьютерного зрения на борту БАС было решено попробовать несколько путей, используя различный технологический стек. Первым возможным решением могла стать связка языка программирования Python, а также библиотек OpenCV и TesseractOCR. Данные инструменты были выбраны не случайно: ЯП Python позволяет быстро и в короткие сроки представить действенное решение для практически любой задачи благодаря простоте своего синтаксиса, однако жертвуя при этом производительностью, поскольку данный язык интерпретируемый, а не компилируемый, как например C++ или Go. Библиотека OpenCV была выбрана, как флагманская среди области компьютерного зрения, а враппер библиотеки TesseractOCR под язык Python мог идеально подойти под задачу распознавания буквенного символа. 

### В тусклом свете Тессеракта

Первая проблема, которая была выявлена при тестах первых сниппетов программы CV - не очень успешное распознавание не такого распространенного, как, скажем, английский, армянского языка. Несмотря на то, что TesseractOCR "из коробки" предоставляет множество обученных моделей, однако файл именно под армянское написание (hye.traineddata) оказался мало полезен. Поскольку данных о том, как производилось обучение модели для этого языка нет, остается лишь предполагать, в чем проблема - как вариант, отличающийся шрифт. 

После изучения множества материалов по обучению Tesseract на своем наборе данных, удалось добиться гораздо более точного распознавания благодаря обучению модели на том шрифте, который был представлен в регламенте конкурса. В результате с помощью стандартного функционала обучения TesseractOCR и программы разметки данных jTessBoxEditor был получен файл arm.traineddata. Однако не время расслабляться - оставалось решить еще 2 проблемы: Первая - "холостые" распознавания, а вторая - распознавание только на небольшом расстоянии. С решением первой недоработки проблем не возникло - была усовершенствована функция предобработки кадра (main.py: frame_preprocessing), которая теперь возвращает изображение, идеально подходящее для последующего распознавания на нём буквы, а так же добавлено условие, фильтрующее выдачу функции распознавания - теперь успешными считались только результаты, в которых степень "уверенности" достигала 80% и более. 

И всё же остается вторая неприятность - проблемы с распознаванием на более отдалённой дистанции. В голову сразу пришла идея обнаруживать на темном фоне светлую прямоугольную карточку/щит с тёмной буквой на нем и обрезать по найденной цели кадр. На помощь пришли библиотеки PIL и imutils, после чего функция main.py: crop_frame_by_color() была готова к использованию внутри функции полной обработки кадра. Результат применения совокупности всех описанных методов можно увидеть в README.md внутри репозитория проекта.

Что мы имеем в итоге? Распознавания на удаленной дистанции достичь не удалось, однако отслеживание белого объекта с буквой в кадре, позволяет в принципе установить факт наличия в области щита с буквой, что решает лишь половину задачи.

### OCR in Tesseract stands for "Outrightly Crappy Result"

"Первый блин комом". Неудача с TesseractOCR не повод завершить работы, поэтому было решено перейти к другому способу решения задачи CV - распознаванию буквы, как отдельного объекта, а не в качестве одиночного символа (так еще и малого шрифта из-за съемки с высоты...). Для этого была выбрана библиотека TensorFlow, поскольку она а) Проста в использовании, б) Готова из коробки предоставить эффективные методы object detection. 

На данный момент активно ведутся работы по обучению модели TF на собственном датасете с изображениями букв армянского алфавита. Собранный датасет включается в себя более 250 фотографий карточек с армянскими буквами под различным углом и с различной высотой съемки.

### Определение координаты буквы

При настройке TensorFlow, к которой мы стремимся, "детект" щита с буквой будет происходить на каждом кадре пролёта, когда он находится в поле зрения камеры, соответственно, поскольку скорость ЛА постоянна/колеблется около постоянного значения, для определения наиболее точных координат хорошим решением будет вычисление среднего арифметического всех найденных координат.

Рассмотрим на модели:

![Анимация пролета над буквой](https://i.yapx.ru/XnuUO.gif)

Было зафиксировано 6 координат, в которых была обнаружена буква: (1, 2, 3, 4, 5, 6). Средним арифметическим будет число 3.5, которое как раз будет находиться в центре изображения (точка с координатой 3 находится чуть выше центра, а с координатой 4 чуть ниже), а значит именно на этой координате располагается буква.

Поскольку количество координат, связанных с одной буквой в реальном полете ограничено лишь фреймрейтом камеры, то точность вычислений будет еще больше.

